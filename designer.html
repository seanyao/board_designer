<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Board designer</title>
<style>
    html,body{height:100%;margin:0;background:#f5f5f5;
              display:flex;justify-content:center;align-items:center;font-family:Arial,Helvetica,sans-serif;}
    .wrapper{position:relative}
    .canvas{
        position:relative;
        width:17cm;
        height:17cm;
        border:2px solid #000;
        background:#fff;
        background-image:
            linear-gradient(#ddd 1px,transparent 1px),
            linear-gradient(90deg,#ddd 1px,transparent 1px);
        background-size:5mm 5mm;
        overflow:hidden;
    }
    /* 单组孔位容器 */
    .hole-group{position:absolute;top:0;left:0;cursor:move}
    /* M3 孔位：外径6 mm 圆环+中心文字 */
    .m3-hole{
        position:absolute;
        width:6mm;
        height:6mm;
        border-radius:50%;
        transform:translate(-50%,-50%);
        user-select:none;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:7px;
        font-weight:bold;
        color:#fff;
        z-index:10;
    }
    /* 虚线边 */
    .edge{
        position:absolute;
        pointer-events:none;
        border-top:1px dashed;
        transform-origin:left top;
    }
    /* 边长标签 */
    .edge-label{
        position:absolute;
        font-size:10px;
        background:rgba(0,0,0,.7);
        color:#fff;
        padding:1px 3px;
        border-radius:2px;
        pointer-events:none;
        white-space:nowrap;
    }
    /* 画布外框尺寸标签 */
    .canvas-label{
        position:absolute;
        font-size:12px;
        background:rgba(0,0,0,.8);
        color:#fff;
        padding:2px 4px;
        border-radius:2px;
        pointer-events:none;
        white-space:nowrap;
        z-index:20;
    }
    
</style>
</head>
<body>
<div class="wrapper">
    <div class="canvas" id="canvas"></div>
</div>

<script>
const canvas   = document.getElementById('canvas');
const wrapper  = document.querySelector('.wrapper');
const mmPerPx = 25.4 / 96;
const grid    = 5 / mmPerPx;          // 5 mm 网格
let groupId   = 0;                    // 组计数
const colors  = ['#e00','#007bff','#28a745','#fd7e14','#6f42c1','#20c997']; // 循环色

/* ---------- 工具 ---------- */
const mm = v => Math.round(v * mmPerPx);

/* ---------- 外框尺寸标签 ---------- */
function updateCanvasSizeLabels(){
    // 移除任何位置的旧标签（无论在 wrapper 还是 canvas 内）
    document.querySelectorAll('.canvas-label').forEach(el=>el.remove());

    const w = canvas.clientWidth;
    const h = canvas.clientHeight;
    const wmm = mm(w);
    const hmm = mm(h);

    const canvasLeft = canvas.offsetLeft;
    const canvasTop  = canvas.offsetTop;

    const topLab = document.createElement('div');
    topLab.className = 'canvas-label';
    topLab.textContent = wmm + ' mm';
    topLab.style.left = (canvasLeft + w / 2) + 'px';
    topLab.style.top = (canvasTop - 8) + 'px';
    topLab.style.transform = 'translateX(-50%)';
    wrapper.appendChild(topLab);

    const rightLab = document.createElement('div');
    rightLab.className = 'canvas-label';
    rightLab.textContent = hmm + ' mm';
    rightLab.style.left = (canvasLeft + w + 8) + 'px';
    rightLab.style.top = (canvasTop + h / 2) + 'px';
    rightLab.style.transform = 'translateY(-50%) rotate(-90deg)';
    wrapper.appendChild(rightLab);
}

/* ---------- 创建一组四孔位矩形 ---------- */
function createHoleGroup(x0,y0,color){
    const gid   = ++groupId;
    const group = document.createElement('div');
    group.className = 'hole-group';
    group.id = 'g'+gid;
    group.dataset.color = color;
    canvas.appendChild(group);

    /* 初始 4 个孔位（顺时针） */
    const pts = [
        {x:x0,      y:y0},
        {x:x0+40,   y:y0},
        {x:x0+40,   y:y0+40},
        {x:x0,      y:y0+40}
    ];
    pts.forEach((p,i)=>{
        const h = document.createElement('div');
        h.className = 'm3-hole';
        h.style.left = p.x + 'px';
        h.style.top  = p.y + 'px';
        h.style.backgroundColor = color;
        h.textContent = 'M3';
        h.dataset.idx = i;
        group.appendChild(h);
    });

    updateGroup(group);
    enableDrag(group);
}

/* ---------- 更新连线、标签 ---------- */
function updateGroup(group){
    const holes = Array.from(group.children);
    const pts   = holes.map(h=>({x:h.offsetLeft,y:h.offsetTop}));

    /* 移除旧元素 */
    group.querySelectorAll('.edge,.edge-label').forEach(el=>el.remove());

    /* 边与标签 */
    for(let i=0;i<4;i++){
        const p1 = pts[i], p2 = pts[(i+1)%4];
        const len = mm(Math.hypot(p2.x-p1.x,p2.y-p1.y));
        const midX=(p1.x+p2.x)/2, midY=(p1.y+p2.y)/2;
        const ang=Math.atan2(p2.y-p1.y,p2.x-p1.x);

        const edge = document.createElement('div');
        edge.className='edge';
        edge.style.left=p1.x+'px'; edge.style.top=p1.y+'px';
        edge.style.width=Math.hypot(p2.x-p1.x,p2.y-p1.y)+'px';
        edge.style.transform=`rotate(${ang}rad)`;
        edge.style.borderColor=group.dataset.color;
        group.appendChild(edge);

        const lab = document.createElement('div');
        lab.className='edge-label';
        lab.textContent=len+' mm';
        lab.style.left=midX+'px'; lab.style.top=midY+'px';
        group.appendChild(lab);
    }
}

/* ---------- 单孔拖拽 ---------- */
function enableDrag(group){
    const holes = Array.from(group.querySelectorAll('.m3-hole'));

    holes.forEach(hole=>{
        let active = false, ox=0, oy=0;
        hole.addEventListener('mousedown', e=>{
            active = true;
            e.stopPropagation();          // 防止触发整组事件
            const rect = canvas.getBoundingClientRect();
            ox = e.clientX - rect.left - hole.offsetLeft;
            oy = e.clientY - rect.top  - hole.offsetTop;
        });

        hole.addEventListener('dblclick', e=>{
            e.stopPropagation();
            const groupEl = hole.closest('.hole-group');
            if(groupEl && confirm('Confirm to delete this group？')){
                groupEl.remove();
            }
        });

        window.addEventListener('mousemove', e=>{
            if(!active) return;
            const rect = canvas.getBoundingClientRect();
            let x = e.clientX - rect.left - ox;
            let y = e.clientY - rect.top  - oy;

            x = Math.max(0, Math.min(x, rect.width));
            y = Math.max(0, Math.min(y, rect.height));

            x = Math.round(x / grid) * grid;
            y = Math.round(y / grid) * grid;

            hole.style.left = x + 'px';
            hole.style.top  = y + 'px';
            updateGroup(group);           // 重新画线
        });

        window.addEventListener('mouseup', ()=> active = false);
    });
}

/* ---------- 双击新建组 ---------- */
canvas.addEventListener('dblclick',e=>{
    const rect = canvas.getBoundingClientRect();
    let x = e.clientX - rect.left;
    let y = e.clientY - rect.top;
    x = Math.round(x/grid)*grid;
    y = Math.round(y/grid)*grid;
    const color = colors[(groupId)%colors.length];
    createHoleGroup(x,y,color);
    updateCanvasSizeLabels();
});

/* ---------- 初始示例组 ---------- */
createHoleGroup(20,20,colors[0]);
updateCanvasSizeLabels();
window.addEventListener('resize', updateCanvasSizeLabels);
</script>
</body>
</html>