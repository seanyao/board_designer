<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Board designer</title>
<style>
    html,body{height:100%;margin:0;background:#f5f5f5;
              display:flex;justify-content:center;align-items:center;font-family:Arial,Helvetica,sans-serif;}
    .wrapper{position:relative}
    .canvas{
        position:relative;
        width:17cm;
        height:17cm;
        border:2px solid #000;
        background:#fff;
        background-image:
            linear-gradient(#ddd 1px,transparent 1px),
            linear-gradient(90deg,#ddd 1px,transparent 1px);
        background-size:5mm 5mm;
        overflow:hidden;
    }
    /* 单组孔位容器 */
    .hole-group{position:absolute;top:0;left:0;cursor:move}
    /* M3 孔位：外径6 mm 圆环+中心文字 */
    .m3-hole{
        position:absolute;
        width:6mm;
        height:6mm;
        border-radius:50%;
        transform:translate(-50%,-50%);
        user-select:none;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:7px;
        font-weight:bold;
        color:#fff;
        z-index:10;
    }
    /* 虚线边 */
    .edge{
        position:absolute;
        pointer-events:none;
        border-top:1px dashed;
        transform-origin:left top;
    }
    /* 边长标签 */
    .edge-label{
        position:absolute;
        font-size:10px;
        background:rgba(0,0,0,.7);
        color:#fff;
        padding:1px 3px;
        border-radius:2px;
        pointer-events:none;
        white-space:nowrap;
    }
    /* 画布外框尺寸标签 */
    .canvas-label{
        position:absolute;
        font-size:12px;
        background:rgba(0,0,0,.8);
        color:#fff;
        padding:2px 4px;
        border-radius:2px;
        pointer-events:none;
        white-space:nowrap;
        z-index:20;
    }
    
    /* 选择菜单 */
    .selection-menu{
        position:fixed;
        top:50%;
        left:50%;
        transform:translate(-50%,-50%);
        background:#fff;
        border:2px solid #333;
        border-radius:8px;
        padding:20px;
        box-shadow:0 4px 20px rgba(0,0,0,.3);
        z-index:1000;
        display:none;
    }
    .selection-menu h3{
        margin:0 0 15px 0;
        color:#333;
        text-align:center;
    }
    .selection-menu button{
        display:block;
        width:200px;
        margin:10px 0;
        padding:12px;
        border:1px solid #ddd;
        border-radius:4px;
        background:#f8f9fa;
        cursor:pointer;
        font-size:14px;
        transition:all .2s;
    }
    .selection-menu button:hover{
        background:#e9ecef;
        border-color:#adb5bd;
    }
    .selection-menu button:active{
        background:#dee2e6;
    }
    /* 零件矩形 */
    .part-rectangle{
        position:absolute;
        background:rgba(128,128,128,0.6);
        border:2px solid #666;
        cursor:move;
        user-select:none;
    }
    /* 零件调整手柄 */
    .resize-handle{
        position:absolute;
        width:8px;
        height:8px;
        background:#fff;
        border:1px solid #333;
        cursor:pointer;
    }
    .resize-handle.nw{top:-4px;left:-4px;cursor:nw-resize;}
    .resize-handle.ne{top:-4px;right:-4px;cursor:ne-resize;}
    .resize-handle.sw{bottom:-4px;left:-4px;cursor:sw-resize;}
    .resize-handle.se{bottom:-4px;right:-4px;cursor:se-resize;}
    /* 零件中心尺寸标签 */
    .part-center-label{
        position:absolute;
        font-size:11px;
        background:rgba(255,255,255,0.9);
        color:#333;
        padding:2px 6px;
        border-radius:3px;
        pointer-events:none;
        white-space:nowrap;
        z-index:15;
        border:1px solid #999;
        font-weight:bold;
    }
        /* 右键菜单 */
        .context-menu{
        position:fixed;
        background:#fff;
        border:1px solid #ccc;
        border-radius:4px;
        box-shadow:0 2px 10px rgba(0,0,0,.2);
        padding:5px 0;
        z-index:1001;
        display:none;
        min-width:150px;
    }
    .context-menu-item{
        padding:8px 15px;
        cursor:pointer;
        font-size:14px;
        border-bottom:1px solid #eee;
    }
    .context-menu-item:last-child{
        border-bottom:none;
    }
    .context-menu-item:hover{
        background:#f5f5f5;
    }

</style>
</head>
<body>
<div class="wrapper">
    <div class="canvas" id="canvas"></div>
</div>

<!-- 选择菜单 -->
<div class="selection-menu" id="selectionMenu">
    <h3>选择创建类型</h3>
    <button onclick="createHoleGroupFromMenu()">一组孔位（4个）</button>
    <button onclick="createPartFromMenu()">一个零件</button>
    <button onclick="closeSelectionMenu()">取消</button>
</div>

<!-- 右键菜单 -->
<div class="context-menu" id="contextMenu">
    <div class="context-menu-item" onclick="createHoleGroupFromContext()">创建孔位组</div>
    <div class="context-menu-item" onclick="createPartFromContext()">创建零件</div>
</div>

<script>
    /* ---------- 右键菜单管理 ---------- */
function showContextMenu(e) {
    e.preventDefault(); // 阻止默认右键菜单
    
    const rect = canvas.getBoundingClientRect();
    let x = e.clientX - rect.left;
    let y = e.clientY - rect.top;
    x = Math.round(x / grid) * grid;
    y = Math.round(y / grid) * grid;
    
    pendingPosition = {x, y};
    
    const contextMenu = document.getElementById('contextMenu');
    contextMenu.style.display = 'block';
    contextMenu.style.left = e.clientX + 'px';
    contextMenu.style.top = e.clientY + 'px';
}

function hideContextMenu() {
    document.getElementById('contextMenu').style.display = 'none';
}

function createHoleGroupFromContext() {
    if (pendingPosition) {
        const color = colors[(groupId) % colors.length];
        createHoleGroup(pendingPosition.x, pendingPosition.y, color);
        updateCanvasSizeLabels();
        hideContextMenu();
    }
}

function createPartFromContext() {
    if (pendingPosition) {
        createPart(pendingPosition.x, pendingPosition.y);
        updateCanvasSizeLabels();
        hideContextMenu();
    }
}

const canvas   = document.getElementById('canvas');
const wrapper  = document.querySelector('.wrapper');
const mmPerPx = 25.4 / 96;
const grid    = 5 / mmPerPx;          // 5 mm 网格
let groupId   = 0;                    // 组计数
let partId    = 0;                    // 零件计数
let pendingPosition = null;           // 待创建位置
const colors  = ['#e00','#007bff','#28a745','#fd7e14','#6f42c1','#20c997']; // 循环色

/* ---------- 工具 ---------- */
const mm = v => Math.round(v * mmPerPx);

/* ---------- 外框尺寸标签 ---------- */
function updateCanvasSizeLabels(){
    // 移除任何位置的旧标签（无论在 wrapper 还是 canvas 内）
    document.querySelectorAll('.canvas-label').forEach(el=>el.remove());

    const w = canvas.clientWidth;
    const h = canvas.clientHeight;
    const wmm = mm(w);
    const hmm = mm(h);

    const canvasLeft = canvas.offsetLeft;
    const canvasTop  = canvas.offsetTop;

    const topLab = document.createElement('div');
    topLab.className = 'canvas-label';
    topLab.textContent = wmm + ' mm';
    topLab.style.left = (canvasLeft + w / 2) + 'px';
    topLab.style.top = (canvasTop - 8) + 'px';
    topLab.style.transform = 'translateX(-50%)';
    wrapper.appendChild(topLab);

    const rightLab = document.createElement('div');
    rightLab.className = 'canvas-label';
    rightLab.textContent = hmm + ' mm';
    rightLab.style.left = (canvasLeft + w + 8) + 'px';
    rightLab.style.top = (canvasTop + h / 2) + 'px';
    rightLab.style.transform = 'translateY(-50%) rotate(-90deg)';
    wrapper.appendChild(rightLab);
}

/* ---------- 创建一组四孔位矩形 ---------- */
function createHoleGroup(x0,y0,color){
    const gid   = ++groupId;
    const group = document.createElement('div');
    group.className = 'hole-group';
    group.id = 'g'+gid;
    group.dataset.color = color;
    canvas.appendChild(group);

    /* 初始 4 个孔位（顺时针） */
    const pts = [
        {x:x0,      y:y0},
        {x:x0+40,   y:y0},
        {x:x0+40,   y:y0+40},
        {x:x0,      y:y0+40}
    ];
    pts.forEach((p,i)=>{
        const h = document.createElement('div');
        h.className = 'm3-hole';
        h.style.left = p.x + 'px';
        h.style.top  = p.y + 'px';
        h.style.backgroundColor = color;
        h.textContent = 'M3';
        h.dataset.idx = i;
        group.appendChild(h);
    });

    updateGroup(group);
    enableDrag(group);
}

/* ---------- 更新连线、标签 ---------- */
function updateGroup(group){
    const holes = Array.from(group.children);
    const pts   = holes.map(h=>({x:h.offsetLeft,y:h.offsetTop}));

    /* 移除旧元素 */
    group.querySelectorAll('.edge,.edge-label').forEach(el=>el.remove());

    /* 边与标签 */
    for(let i=0;i<4;i++){
        const p1 = pts[i], p2 = pts[(i+1)%4];
        const len = mm(Math.hypot(p2.x-p1.x,p2.y-p1.y));
        const midX=(p1.x+p2.x)/2, midY=(p1.y+p2.y)/2;
        const ang=Math.atan2(p2.y-p1.y,p2.x-p1.x);

        const edge = document.createElement('div');
        edge.className='edge';
        edge.style.left=p1.x+'px'; edge.style.top=p1.y+'px';
        edge.style.width=Math.hypot(p2.x-p1.x,p2.y-p1.y)+'px';
        edge.style.transform=`rotate(${ang}rad)`;
        edge.style.borderColor=group.dataset.color;
        group.appendChild(edge);

        const lab = document.createElement('div');
        lab.className='edge-label';
        lab.textContent=len+' mm';
        lab.style.left=midX+'px'; lab.style.top=midY+'px';
        group.appendChild(lab);
    }
}

/* ---------- 单孔拖拽 ---------- */
function enableDrag(group){
    const holes = Array.from(group.querySelectorAll('.m3-hole'));

    holes.forEach(hole=>{
        let active = false, ox=0, oy=0;
        hole.addEventListener('mousedown', e=>{
            active = true;
            e.stopPropagation();          // 防止触发整组事件
            const rect = canvas.getBoundingClientRect();
            ox = e.clientX - rect.left - hole.offsetLeft;
            oy = e.clientY - rect.top  - hole.offsetTop;
        });

        hole.addEventListener('dblclick', e=>{
            e.stopPropagation();
            const groupEl = hole.closest('.hole-group');
            if(groupEl && confirm('Confirm to delete this group？')){
                groupEl.remove();
            }
        });

        window.addEventListener('mousemove', e=>{
            if(!active) return;
            const rect = canvas.getBoundingClientRect();
            let x = e.clientX - rect.left - ox;
            let y = e.clientY - rect.top  - oy;

            x = Math.max(0, Math.min(x, rect.width));
            y = Math.max(0, Math.min(y, rect.height));

            x = Math.round(x / grid) * grid;
            y = Math.round(y / grid) * grid;

            hole.style.left = x + 'px';
            hole.style.top  = y + 'px';
            updateGroup(group);           // 重新画线
        });

        window.addEventListener('mouseup', ()=> active = false);
    });
}

/* ---------- 选择菜单管理 ---------- */
function showSelectionMenu(x, y) {
    pendingPosition = {x, y};
    document.getElementById('selectionMenu').style.display = 'block';
}

function closeSelectionMenu() {
    document.getElementById('selectionMenu').style.display = 'none';
    pendingPosition = null;
}

function createHoleGroupFromMenu() {
    if (pendingPosition) {
        const color = colors[(groupId) % colors.length];
        createHoleGroup(pendingPosition.x, pendingPosition.y, color);
        updateCanvasSizeLabels();
        closeSelectionMenu();
    }
}

function createPartFromMenu() {
    if (pendingPosition) {
        createPart(pendingPosition.x, pendingPosition.y);
        updateCanvasSizeLabels();
        closeSelectionMenu();
    }
}

/* ---------- 创建零件 ---------- */
function createPart(x0, y0) {
    const pid = ++partId;
    const part = document.createElement('div');
    part.className = 'part-rectangle';
    part.id = 'p' + pid;
    part.style.left = x0 + 'px';
    part.style.top = y0 + 'px';
    part.style.width = '60px';
    part.style.height = '40px';
    canvas.appendChild(part);

    // 添加调整手柄
    const handles = ['nw', 'ne', 'sw', 'se'];
    handles.forEach(pos => {
        const handle = document.createElement('div');
        handle.className = `resize-handle ${pos}`;
        part.appendChild(handle);
    });

    enablePartDrag(part);
    enablePartResize(part);
    updatePartCenterLabel(part); // 初始显示中心尺寸标签
}

/* ---------- 更新零件中心尺寸标签 ---------- */
function updatePartCenterLabel(part) {
    // 移除旧的尺寸标签
    part.querySelectorAll('.part-center-label').forEach(el => el.remove());
    
    const width = part.offsetWidth;
    const height = part.offsetHeight;
    
    // 创建中心标签
    const label = document.createElement('div');
    label.className = 'part-center-label';
    label.textContent = `${mm(width)} × ${mm(height)} mm`;
    
    // 居中定位
    label.style.left = '50%';
    label.style.top = '50%';
    label.style.transform = 'translate(-50%, -50%)';
    
    part.appendChild(label);
}

/* ---------- 零件拖拽 ---------- */
function enablePartDrag(part) {
    let active = false, ox = 0, oy = 0;
    
    part.addEventListener('mousedown', e => {
        if (e.target.classList.contains('resize-handle')) return;
        active = true;
        e.stopPropagation();
        const rect = canvas.getBoundingClientRect();
        ox = e.clientX - rect.left - part.offsetLeft;
        oy = e.clientY - rect.top - part.offsetTop;
    });

    window.addEventListener('mousemove', e => {
        if (!active) return;
        const rect = canvas.getBoundingClientRect();
        let x = e.clientX - rect.left - ox;
        let y = e.clientY - rect.top - oy;

        x = Math.max(0, Math.min(x, rect.width - part.offsetWidth));
        y = Math.max(0, Math.min(y, rect.height - part.offsetHeight));

        x = Math.round(x / grid) * grid;
        y = Math.round(y / grid) * grid;

        part.style.left = x + 'px';
        part.style.top = y + 'px';
        updatePartCenterLabel(part); // 拖拽时更新标签位置
    });

    window.addEventListener('mouseup', () => active = false);
}

/* ---------- 零件大小调整 ---------- */
function enablePartResize(part) {
    const handles = part.querySelectorAll('.resize-handle');
    
    handles.forEach(handle => {
        let active = false, startX = 0, startY = 0, startWidth = 0, startHeight = 0, startLeft = 0, startTop = 0;
        
        handle.addEventListener('mousedown', e => {
            active = true;
            e.stopPropagation();
            const rect = canvas.getBoundingClientRect();
            startX = e.clientX;
            startY = e.clientY;
            startWidth = part.offsetWidth;
            startHeight = part.offsetHeight;
            startLeft = part.offsetLeft;
            startTop = part.offsetTop;
        });

        window.addEventListener('mousemove', e => {
            if (!active) return;
            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;
            
            let newWidth = startWidth;
            let newHeight = startHeight;
            let newLeft = startLeft;
            let newTop = startTop;

            if (handle.classList.contains('se')) {
                newWidth = Math.max(20, startWidth + deltaX);
                newHeight = Math.max(20, startHeight + deltaY);
            } else if (handle.classList.contains('sw')) {
                newWidth = Math.max(20, startWidth - deltaX);
                newHeight = Math.max(20, startHeight + deltaY);
                newLeft = startLeft + startWidth - newWidth;
            } else if (handle.classList.contains('ne')) {
                newWidth = Math.max(20, startWidth + deltaX);
                newHeight = Math.max(20, startHeight - deltaY);
                newTop = startTop + startHeight - newHeight;
            } else if (handle.classList.contains('nw')) {
                newWidth = Math.max(20, startWidth - deltaX);
                newHeight = Math.max(20, startHeight - deltaY);
                newLeft = startLeft + startWidth - newWidth;
                newTop = startTop + startHeight - newHeight;
            }

            // 网格对齐
            newWidth = Math.round(newWidth / grid) * grid;
            newHeight = Math.round(newHeight / grid) * grid;
            newLeft = Math.round(newLeft / grid) * grid;
            newTop = Math.round(newTop / grid) * grid;

            // 边界检查
            if (newLeft < 0) newLeft = 0;
            if (newTop < 0) newTop = 0;
            if (newLeft + newWidth > canvas.offsetWidth) newWidth = canvas.offsetWidth - newLeft;
            if (newTop + newHeight > canvas.offsetHeight) newHeight = canvas.offsetHeight - newTop;

            part.style.width = newWidth + 'px';
            part.style.height = newHeight + 'px';
            part.style.left = newLeft + 'px';
            part.style.top = newTop + 'px';
            
            updatePartCenterLabel(part); // 调整大小时更新标签
        });

        window.addEventListener('mouseup', () => active = false);
    });
}

/* ---------- 右键新建 ---------- */
canvas.addEventListener('contextmenu', showContextMenu);

// 点击其他地方隐藏右键菜单
document.addEventListener('click', hideContextMenu);
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') hideContextMenu();
});

/* ---------- 初始示例组 ---------- */
createHoleGroup(20,20,colors[0]);
updateCanvasSizeLabels();
window.addEventListener('resize', updateCanvasSizeLabels);
</script>
</body>
</html>